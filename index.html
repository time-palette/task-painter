<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Çø„Çπ„ÇØPainter Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* „Çπ„ÉÜ„Ç£„ÉÉ„Ç≠„Éº„Éò„ÉÉ„ÉÄ„Éº & „Ç´„É©„É† */
        .sticky-header { position: sticky; top: 0; z-index: 30; }
        .sticky-col { position: sticky; left: 0; z-index: 40; } 
        .sticky-corner { position: sticky; top: 0; left: 0; z-index: 50; }

        /* „Ç∫„Éº„É†Âà∂Âæ°Áî®Â§âÊï∞ */
        :root {
            --row-height: 40px;
            --col-width: 90px;
            --font-scale: 1;
        }

        /* Ë°å„ÅÆÈ´ò„Åï„ÇíÂèØÂ§â„Å´ */
        .schedule-row {
            height: var(--row-height) !important;
            transition: height 0.1s ease-out;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Åø„ÅßÂπÖ„ÇíÂà∂Âæ° */
        .dynamic-col-width {
            min-width: var(--col-width) !important;
            width: var(--col-width) !important;
            transition: min-width 0.1s ease-out, width 0.1s ease-out;
        }
        
        /* ‰∏≠Ë∫´„ÅÆÊñáÂ≠ó„Çµ„Ç§„Ç∫„Å™„Å©„ÇÇËøΩÂæì */
        .zoom-content-title {
            font-size: calc(10px * var(--font-scale));
            line-height: 1.1;
        }
        .zoom-content-detail {
            font-size: calc(8.5px * var(--font-scale));
            line-height: 1.05;
        }
        .zoom-icon {
             transform: scale(var(--font-scale));
        }

        /* Êó•Ê¨°„É°„É¢„ÅÆ„Çª„É´„Çπ„Çø„Ç§„É´ */
        .daily-memo-cell {
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 10px;
            line-height: 1.3;
            vertical-align: top;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .pop-in { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* ÂâäÈô§„É¢„Éº„ÉâÊôÇ„ÅÆ„Éó„É´„Éó„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-1deg); }
            100% { transform: rotate(0deg); }
        }
        .shake-anim { animation: shake 0.2s infinite; }

        /* „Éà„Éº„Çπ„ÉàÈÄöÁü• */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 80px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 100px;
        }

        /* „Éë„É¨„ÉÉ„ÉàÈÅ∏ÊäûÊôÇ„ÅÆÂº∑Ë™ø */
        .palette-item.selected { 
            transform: scale(1.02); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-width: 2px;
            border-color: #4f46e5;
        }

        /* „Çπ„É©„Ç§„ÉÄ„Éº */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: #4f46e5; margin-top: -5px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px;
        }
        
        /* Êó•‰ªò„Éî„ÉÉ„Ç´„Éº„ÅÆ„Éè„ÉÉ„ÇØ */
        .date-picker-wrapper {
            position: relative;
            display: inline-block;
        }
        .date-picker-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden select-none">

    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-2 shadow-md z-50 flex-shrink-0 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="bg-white/20 p-1.5 rounded-lg border border-white/30">
                <i data-lucide="paintbrush" class="w-5 h-5 text-white"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold leading-none tracking-wide">„Çø„Çπ„ÇØPainter</h1>
                <div class="text-[10px] opacity-90 font-mono tracking-wider">Paint Your Schedule</div>
            </div>
        </div>
        <div class="flex gap-2 items-center">
            <!-- Save/Load Buttons -->
            <button onclick="exportData()" class="text-white bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-full flex items-center gap-1 transition-all backdrop-blur-sm border border-white/10" title="JSON„Éï„Ç°„Ç§„É´„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰øùÂ≠ò">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span class="text-xs font-bold hidden md:inline">‰øùÂ≠ò</span>
            </button>
            <button onclick="triggerImport()" class="text-white bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-full flex items-center gap-1 transition-all backdrop-blur-sm border border-white/10" title="„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Åã„ÇâÂæ©ÂÖÉ">
                <i data-lucide="upload" class="w-4 h-4"></i>
                <span class="text-xs font-bold hidden md:inline">Âæ©ÂÖÉ</span>
            </button>
            <input type="file" id="import-file" style="display:none" accept=".json" onchange="importData(this)">

            <!-- Undo Button -->
            <button onclick="undo()" id="undo-btn" class="text-white bg-white/20 hover:bg-white/30 disabled:opacity-30 disabled:cursor-not-allowed px-3 py-1.5 rounded-full flex items-center gap-1 transition-all backdrop-blur-sm border border-white/10" disabled>
                <i data-lucide="undo-2" class="w-4 h-4"></i>
                <span class="text-xs font-bold">ÂÖÉ„Å´Êàª„Åô</span>
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex flex-col min-w-0 bg-white relative overflow-hidden">
        
        <!-- Date Navigation & Zoom Control -->
        <div class="flex items-center justify-between px-2 py-2 border-b bg-slate-50 flex-shrink-0 shadow-sm z-10 gap-2">
            
            <!-- Date Nav -->
            <div class="flex items-center gap-1 flex-shrink-0">
                <button id="prev-btn" class="p-1.5 bg-white border rounded-full hover:bg-slate-100 active:scale-90 transition text-slate-600"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                <div class="text-center w-20" id="date-display">
                    <span class="text-xs font-bold text-slate-700 block">--/--</span>
                </div>
                <button id="next-btn" class="p-1.5 bg-white border rounded-full hover:bg-slate-100 active:scale-90 transition text-slate-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                
                <!-- Date Picker Trigger -->
                <div class="date-picker-wrapper ml-1" title="Êó•‰ªò„ÇíÊåáÂÆö„Åó„Å¶„Ç∏„É£„É≥„Éó">
                    <button class="p-1.5 bg-indigo-50 border border-indigo-100 rounded-full hover:bg-indigo-100 active:scale-90 transition text-indigo-600">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                    </button>
                    <input type="date" id="date-picker-input" class="date-picker-input">
                </div>
            </div>

            <!-- Zoom Slider -->
            <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border shadow-sm ml-auto">
                <i data-lucide="minus" class="w-3 h-3 text-slate-400"></i>
                <input type="range" id="zoom-slider" min="15" max="60" value="40" class="w-20 md:w-32 cursor-pointer">
                <i data-lucide="plus" class="w-3 h-3 text-slate-400"></i>
            </div>
        </div>

        <!-- Schedule Table Scroll Area -->
        <div class="flex-1 overflow-auto bg-slate-50/30 relative" id="schedule-scroll">
            <table class="w-full border-collapse table-fixed bg-white">
                <thead class="bg-slate-50 text-slate-500 text-xs shadow-sm">
                    <tr id="header-row"></tr>
                </thead>
                <tbody id="body-rows"></tbody>
            </table>

            <!-- Weekly Memo Section -->
            <div class="p-4 md:p-6 mb-24 max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 border-b px-4 py-2 flex items-center justify-between">
                        <h3 class="font-bold text-slate-600 flex items-center gap-2 text-sm">
                            <i data-lucide="lightbulb" class="w-4 h-4 text-amber-500"></i>
                            <span class="tracking-wide">Weekly Memo</span>
                        </h3>
                    </div>
                    <div class="p-0">
                        <textarea id="weekly-memo-input" 
                            class="w-full p-4 text-sm text-slate-700 leading-relaxed focus:outline-none focus:ring-2 focus:ring-indigo-100 min-h-[120px] resize-y bg-slate-50/10 placeholder-slate-300" 
                            placeholder=""></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Task Palette (Footer) -->
    <div class="bg-white border-t shadow-[0_-4px_10px_rgba(0,0,0,0.05)] z-40 flex flex-col flex-shrink-0 transition-all duration-300 relative" style="height: 35vh; max-height: 300px;">
        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-white border px-3 py-0.5 rounded-t-lg text-[10px] text-slate-400 font-bold shadow-sm">PALETTE</div>
        
        <div class="flex justify-between items-center px-4 py-2 border-b bg-slate-50/80 backdrop-blur-sm">
            <span class="text-xs font-bold text-slate-500 flex items-center gap-1">
                <i data-lucide="palette" class="w-3 h-3"></i> „Ç´„É©„ÉºÔºÜ„Çø„Çπ„ÇØ
            </span>
            <div class="flex gap-2">
                <button onclick="addTask()" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded-full hover:bg-indigo-700 active:scale-95 flex items-center gap-1 shadow-sm transition-colors" id="add-btn">
                    <i data-lucide="plus" class="w-3 h-3"></i> ËøΩÂä†
                </button>
                <button onclick="toggleDeleteMode()" id="delete-mode-btn" class="text-slate-400 hover:text-red-500 hover:bg-red-50 px-2 py-1 rounded-full transition-colors flex items-center gap-1 text-xs border border-transparent">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Êï¥ÁêÜ
                </button>
            </div>
        </div>
        
        <!-- Palette Container -->
        <div class="flex-1 overflow-y-auto p-2 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 content-start bg-slate-50/30" id="palette-container">
            <!-- Palette Items Generated JS -->
        </div>
    </div>

    <!-- Detail Edit Modal (Schedule Cell) -->
    <div id="detail-modal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform duration-200 ring-1 ring-black/5" id="modal-content">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700 flex items-center gap-2 text-base">
                    <div id="modal-task-color" class="w-4 h-4 rounded-full bg-gray-300 ring-2 ring-white shadow-sm"></div>
                    <span id="modal-task-name">„Çø„Çπ„ÇØÂêç</span>
                </h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-200 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-5">
                <label class="block text-xs font-bold text-slate-500 mb-2 flex items-center gap-1">
                    <i data-lucide="pencil" class="w-3 h-3"></i> Ë©≥Á¥∞„ÉªËøΩË®ò„É°„É¢
                </label>
                <textarea id="modal-detail-input" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:outline-none bg-white shadow-inner" rows="3" placeholder="‰æã: A‰ºöË≠∞ÂÆ§„Å´„Å¶ / ÈÄ≤Êçó80%"></textarea>
                <div class="text-[10px] text-slate-400 mt-2 text-right">‚ÄªÁ©∫Ê¨Ñ‰øùÂ≠ò„ÅßË©≥Á¥∞„Å™„Åó</div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-between gap-3">
                <button onclick="deleteCell()" class="px-4 py-2.5 text-red-500 text-sm font-bold hover:bg-red-50 rounded-lg flex items-center gap-1.5 transition-colors border border-transparent hover:border-red-100">
                    <i data-lucide="eraser" class="w-4 h-4"></i> Â°ó„Çä„ÇíÊ∂à„Åô
                </button>
                <button onclick="saveDetail()" class="flex-1 px-4 py-2.5 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i> ‰øùÂ≠ò„Åô„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- Task Edit Modal (New!) -->
    <div id="task-edit-modal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform duration-200 ring-1 ring-black/5" id="task-modal-content">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700 flex items-center gap-2 text-base">
                    <i data-lucide="settings-2" class="w-4 h-4 text-slate-500"></i>
                    <span>„Çø„Çπ„ÇØË®≠ÂÆö</span>
                </h3>
                <button onclick="closeTaskEditModal()" class="text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-200 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-5 flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5">„Çø„Çπ„ÇØÂêç</label>
                    <input type="text" id="task-edit-name" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none bg-white font-bold" placeholder="„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 flex items-center gap-1">
                        <i data-lucide="file-text" class="w-3 h-3"></i> „Éû„Ç§„É´„Çπ„Éà„Éº„É≥„Éª„É°„É¢
                    </label>
                    <textarea id="task-edit-memo" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none bg-slate-50/50 shadow-inner" rows="5" placeholder="„Éû„Ç§„É´„Çπ„Éà„Éº„É≥„ÄÅNext Action„ÄÅË¶Å‰ª∂ÂÆöÁæ©„Å™„Å©„Çí„Åì„Åì„Å´Ë®òÈå≤..."></textarea>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3">
                <button onclick="saveTaskEdit()" class="flex-1 px-4 py-2.5 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i> Ë®≠ÂÆö„Çí‰øùÂ≠ò
                </button>
            </div>
        </div>
    </div>

    <!-- Memo Edit Modal (Daily Memo) -->
    <div id="memo-modal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform duration-200 ring-1 ring-black/5" id="memo-modal-content">
            <div class="p-4 border-b flex justify-between items-center bg-yellow-50">
                <h3 class="font-bold text-yellow-800 flex items-center gap-2 text-base">
                    <i data-lucide="sticky-note" class="w-4 h-4"></i>
                    <span id="memo-modal-date">--/-- „ÅÆ„É°„É¢</span>
                </h3>
                <button onclick="closeMemoModal()" class="text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-200 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-5">
                <textarea id="memo-input" class="w-full border border-yellow-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 focus:outline-none bg-yellow-50/50 shadow-inner leading-relaxed" rows="8" placeholder="„Åì„Åì„Å´„É°„É¢„ÇíÂÖ•Âäõ..."></textarea>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3">
                <button onclick="saveMemo()" class="flex-1 px-4 py-2.5 bg-yellow-500 text-white text-sm font-bold rounded-lg hover:bg-yellow-600 shadow-lg shadow-yellow-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i> „É°„É¢„Çí‰øùÂ≠ò
                </button>
            </div>
        </div>
    </div>

    <!-- Color Picker Modal -->
    <div id="color-modal" class="fixed inset-0 bg-black/60 z-[110] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs overflow-hidden transform scale-95 transition-transform duration-200 ring-1 ring-black/5" id="color-modal-content">
            <div class="p-3 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700 text-sm">„Ç´„É©„ÉºÈÅ∏Êäû</h3>
                <button onclick="closeColorModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-4 grid grid-cols-4 gap-3 bg-slate-50" id="color-grid">
                <!-- JS Generated -->
            </div>
        </div>
    </div>

    <script>
        // --- Config & Data ---
        const CONFIG = {
            storageKey: 'task_painter_v6', // Version bumped
            colors: [
                'bg-red-100 text-red-800', 'bg-orange-100 text-orange-800', 'bg-amber-100 text-amber-800',
                'bg-yellow-100 text-yellow-800', 'bg-lime-100 text-lime-800', 'bg-green-100 text-green-800',
                'bg-emerald-100 text-emerald-800', 'bg-teal-100 text-teal-800', 'bg-cyan-100 text-cyan-800',
                'bg-sky-100 text-sky-800', 'bg-blue-100 text-blue-800', 'bg-indigo-100 text-indigo-800',
                'bg-violet-100 text-violet-800', 'bg-purple-100 text-purple-800', 'bg-fuchsia-100 text-fuchsia-800',
                'bg-pink-100 text-pink-800', 'bg-rose-100 text-rose-800', 'bg-slate-200 text-slate-800'
            ],
            hours: { start: 0, end: 24 },
            cursorId: 'CURSOR_MODE'
        };

        const INITIAL_TASKS = [
            { id: 't1', name: 'üé® „Éá„Ç∂„Ç§„É≥', color: 'bg-pink-100 text-pink-800', memo: '„Éû„Ç§„É´„Çπ„Éà„Éº„É≥: 10/20„Åæ„Åß„Å´„ÉØ„Ç§„É§„ÉºÁ¢∫ÂÆö\nNext Action: „É¨„Éï„Ç°„É¨„É≥„ÇπÂèéÈõÜ' },
            { id: 't2', name: 'üíª ÈñãÁô∫', color: 'bg-indigo-100 text-indigo-800', memo: '' },
            { id: 't3', name: 'üó£ MTG', color: 'bg-blue-100 text-blue-800', memo: '' },
            { id: 't4', name: 'üç± „É©„É≥„ÉÅ', color: 'bg-orange-100 text-orange-800', memo: '' },
            { id: 't5', name: 'üöÉ ÁßªÂãï', color: 'bg-slate-200 text-slate-600', memo: '' },
            { id: 't6', name: '‚ú® Ë™øÊï¥', color: 'bg-emerald-100 text-emerald-800', memo: '' },
        ];

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getThisMonday() {
            const today = new Date();
            const day = today.getDay(); // 0:Sun, 1:Mon, ..., 6:Sat
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(today);
            monday.setDate(diff);
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        let state = {
            tasks: [],
            schedule: {}, 
            weeklyMemos: {}, 
            viewDate: getThisMonday(), 
            activeTaskId: CONFIG.cursorId, 
            editingCell: null,
            editingMemoDate: null, 
            editingTaskId: null, // For Task Edit Modal
            deleteMode: false,
            changingColorTaskId: null,
            zoomLevel: 40 
        };

        // --- History / Undo System ---
        let historyStack = [];

        function pushHistory() {
            if(historyStack.length > 20) historyStack.shift();
            historyStack.push(JSON.stringify({
                tasks: state.tasks,
                schedule: state.schedule,
                weeklyMemos: state.weeklyMemos
            }));
            updateUndoButton();
        }

        function undo() {
            if(historyStack.length === 0) return;
            const prevState = JSON.parse(historyStack.pop());
            state.tasks = prevState.tasks;
            state.schedule = prevState.schedule;
            state.weeklyMemos = prevState.weeklyMemos;
            saveData();
            renderAll();
            updateUndoButton();
            showToast("ÂÖÉ„Å´Êàª„Åó„Åæ„Åó„Åü");
        }

        function updateUndoButton() {
            const btn = document.getElementById('undo-btn');
            if (historyStack.length > 0) {
                btn.disabled = false;
                btn.classList.remove('opacity-30', 'cursor-not-allowed');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-30', 'cursor-not-allowed');
            }
        }

        // --- Core ---
        function init() {
            loadData();
            if (!state.activeTaskId) state.activeTaskId = CONFIG.cursorId;
            initZoom(); 
            initWeeklyMemo(); 
            renderAll();
            setupEvents();
            updateUndoButton();
            
            // ÂàùÂõû„É≠„Éº„ÉâÊôÇ„Å´Êúù9ÊôÇ„Å´„Çπ„ÇØ„É≠„Éº„É´
            setTimeout(scrollToMorning, 100);
        }

        function scrollToMorning() {
            const container = document.getElementById('schedule-scroll');
            const target = document.getElementById('start-time-row');
            
            if (container && target) {
                // „Éò„ÉÉ„ÉÄ„Éº„ÅÆÈ´ò„Åï„ÇíËÄÉÊÖÆÔºà„Çπ„ÉÜ„Ç£„ÉÉ„Ç≠„Éº„Éò„ÉÉ„ÉÄ„Éº„ÅÆ‰∏ã„Å´9:00„ÅåÊù•„Çã„Çà„ÅÜ„Å´Ë™øÊï¥Ôºâ
                const header = document.querySelector('thead');
                const headerHeight = header ? header.offsetHeight : 50;
                
                // „Çø„Éº„Ç≤„ÉÉ„Éà‰ΩçÁΩÆ„Åã„Çâ„Éò„ÉÉ„ÉÄ„ÉºÂàÜ„ÇíÂºï„ÅÑ„Å¶„Çπ„ÇØ„É≠„Éº„É´
                container.scrollTop = target.offsetTop - headerHeight;
            }
        }

        function loadData() {
            const json = localStorage.getItem(CONFIG.storageKey);
            if(json) {
                const data = JSON.parse(json);
                state.tasks = data.tasks || INITIAL_TASKS;
                state.schedule = data.schedule || {};
                state.weeklyMemos = data.weeklyMemos || {};
                if(data.zoomLevel) state.zoomLevel = data.zoomLevel;
            } else {
                state.tasks = JSON.parse(JSON.stringify(INITIAL_TASKS));
                state.schedule = {};
                state.weeklyMemos = {};
            }
        }

        function saveData() {
            localStorage.setItem(CONFIG.storageKey, JSON.stringify({
                tasks: state.tasks,
                schedule: state.schedule,
                weeklyMemos: state.weeklyMemos, 
                zoomLevel: state.zoomLevel
            }));
        }

        function initZoom() {
            const slider = document.getElementById('zoom-slider');
            if (state.zoomLevel) {
                slider.value = state.zoomLevel;
                updateZoom(state.zoomLevel);
            }
            slider.oninput = (e) => {
                const val = parseInt(e.target.value);
                state.zoomLevel = val;
                updateZoom(val);
                saveData();
            };
        }

        function updateZoom(heightPx) {
            const root = document.documentElement;
            root.style.setProperty('--row-height', `${heightPx}px`);
            let colWidth = 52 + (heightPx - 15) * (48 / 45);
            root.style.setProperty('--col-width', `${colWidth}px`);
            let scale = 0.65 + ((heightPx - 15) / (60 - 15)) * 0.55; 
            root.style.setProperty('--font-scale', scale);
        }

        // --- Weekly Memo Logic ---
        function getWeeklyMemoKey() {
            const dates = getDates();
            return formatDate(dates[0]);
        }

        function initWeeklyMemo() {
            const memoInput = document.getElementById('weekly-memo-input');
            
            // FocusÊôÇ„Å´Áä∂ÊÖã‰øùÂ≠òÔºàUndoÁî®Ôºâ
            memoInput.addEventListener('focus', () => {
                pushHistory();
            });

            memoInput.addEventListener('input', (e) => {
                const key = getWeeklyMemoKey();
                state.weeklyMemos[key] = e.target.value;
                saveData();
            });
        }

        function updateWeeklyMemoView() {
            const key = getWeeklyMemoKey();
            const memoInput = document.getElementById('weekly-memo-input');
            memoInput.value = state.weeklyMemos[key] || '';
        }

        // --- Render ---
        function renderAll() {
            renderHeader();
            renderBody();
            renderPalette();
            updateWeeklyMemoView(); 
            lucide.createIcons();
        }

        function getDates() {
            const dates = [];
            for(let i=0; i<7; i++) {
                const d = new Date(state.viewDate);
                d.setDate(d.getDate() + i);
                dates.push(d);
            }
            return dates;
        }

        function renderHeader() {
            const dates = getDates();
            const startStr = `${dates[0].getMonth()+1}/${dates[0].getDate()}`;
            const endStr = `${dates[6].getMonth()+1}/${dates[6].getDate()}`;
            document.getElementById('date-display').innerHTML = `<span class="text-[9px] text-slate-400 font-mono tracking-widest block">WEEKLY</span><span class="font-bold text-slate-800 text-sm leading-tight">${startStr} - ${endStr}</span>`;

            let html = `<th class="sticky-corner bg-slate-50 p-2 w-10 border-b border-r border-slate-200 text-[10px] z-50 text-slate-400 font-mono shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">Time</th>`;
            const days = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
            dates.forEach(d => {
                const dayIdx = d.getDay();
                const color = dayIdx===0?'text-red-500 bg-red-50/30': dayIdx===6?'text-blue-500 bg-blue-50/30':'text-slate-600';
                html += `<th class="sticky-header bg-slate-50 dynamic-col-width p-2 border-b border-r z-30 ${color}">
                    <div class="font-bold text-sm zoom-content-title">${d.getDate()}</div>
                    <div class="text-[9px] opacity-75 font-mono tracking-wide zoom-content-title">${days[dayIdx]}</div>
                </th>`;
            });
            document.getElementById('header-row').innerHTML = html;
        }

        function renderBody() {
            const dates = getDates();
            const dateStrs = dates.map(d => formatDate(d));
            let html = '';

            // Time Slots
            const times = [];
            for(let h=CONFIG.hours.start; h<CONFIG.hours.end; h++) {
                times.push(`${h}:00`, `${h}:30`);
            }

            times.forEach(t => {
                // 9:00„ÅÆË°å„Å´ID„Çí‰ªò‰∏é„Åó„Å¶Âæå„Åß„Çπ„ÇØ„É≠„Éº„É´„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
                const rowId = (t === '9:00') ? 'id="start-time-row"' : '';
                
                html += `<tr class="schedule-row" ${rowId}>
                    <td class="sticky-col bg-slate-50 p-0 text-[10px] text-slate-400 font-mono text-center border-b border-r border-slate-200 z-40 select-none align-middle shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                        <div class="flex items-center justify-center h-full w-full">
                            ${t}
                        </div>
                    </td>`;
                
                dateStrs.forEach(d => {
                    const cellData = state.schedule[d]?.[t];
                    const taskId = (typeof cellData === 'string') ? cellData : (cellData?.taskId || null);
                    const detail = (typeof cellData === 'object') ? (cellData?.detail || '') : '';

                    const task = state.tasks.find(tsk => tsk.id === taskId);
                    
                    let content = '';
                    let classes = 'bg-white hover:bg-slate-50';
                    let borderClass = 'border-slate-100';
                    
                    if (task) {
                        classes = `${task.color} cursor-pointer hover:brightness-95 transition-all`;
                        borderClass = 'border-white/20';
                        content = `
                            <div class="flex flex-col items-start justify-start h-full w-full pointer-events-none overflow-hidden px-1 py-0.5 pop-in">
                                <span class="flex-shrink-0 font-bold zoom-content-title w-full text-left break-words leading-tight drop-shadow-sm mb-0.5" 
                                      style="white-space: normal; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                      ${task.name}
                                </span>
                                ${detail ? `
                                    <div class="flex-1 w-full min-h-0 overflow-hidden">
                                        <div class="zoom-content-detail w-full text-left bg-white/60 rounded-sm px-1 py-0.5 font-medium shadow-sm leading-tight text-slate-800 break-words" 
                                             style="white-space: pre-wrap; word-break: break-all;">${detail}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }

                    html += `<td class="max-w-0 border-b border-r ${borderClass} p-0 relative transition-all active:scale-95 duration-75" 
                        onclick="handleCellClick('${d}', '${t}', '${taskId}')">
                        <div class="absolute inset-0 p-0.5 flex items-start justify-center ${classes}">
                            ${content}
                        </div>
                    </td>`;
                });
                html += `</tr>`;
            });

            // Note Row
            html += `<tr><td class="sticky-col bg-yellow-50/90 p-1 text-[9px] font-bold text-center border-t border-r border-slate-200 z-40 text-yellow-600 align-top pt-3 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]" style="height: 120px;">
                        MEMO
                    </td>`;
            dateStrs.forEach(d => {
                const note = state.schedule[d]?.note || '';
                const hasNote = note.length > 0;
                html += `<td class="max-w-0 border-t border-r border-slate-200 bg-yellow-50/20 p-1.5 cursor-pointer hover:bg-yellow-100 transition-colors relative overflow-hidden align-top" style="height: 120px;" onclick="openMemoModal('${d}')">
                    <div class="w-full h-full text-slate-700 daily-memo-cell ${hasNote ? '' : 'flex items-center justify-center'}">
                        ${hasNote ? note : '<i data-lucide="plus" class="w-3 h-3 opacity-30 zoom-icon"></i>'}
                    </div>
                </td>`;
            });
            html += `</tr>`;

            // Copy Button Row
            html += `<tr><td class="sticky-col bg-white p-1 text-center border-t border-r border-slate-200 z-40 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                        <i data-lucide="copy" class="w-4 h-4 mx-auto text-slate-400"></i>
                    </td>`;
            dateStrs.forEach(d => {
                html += `<td class="max-w-0 border-t border-r border-slate-200 bg-white p-1 text-center">
                    <button onclick="copyDaySchedule('${d}')" class="w-full h-full flex items-center justify-center p-1 rounded hover:bg-slate-100 text-slate-400 hover:text-indigo-600 transition-colors" title="„Åì„ÅÆÊó•„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„Çí„Ç≥„Éî„Éº">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </td>`;
            });
            html += `</tr>`;

            document.getElementById('body-rows').innerHTML = html;
        }

        // --- Copy Function ---
        function copyDaySchedule(dateStr) {
            const date = new Date(dateStr);
            const days = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
            const dayName = days[date.getDay()];
            let text = `„Äê${dateStr.replace(/-/g, '/')} (${dayName})„Äë\n`;

            const times = [];
            for(let h=CONFIG.hours.start; h<CONFIG.hours.end; h++) {
                times.push(`${h}:00`, `${h}:30`);
            }

            let hasTask = false;
            times.forEach(t => {
                const cellData = state.schedule[dateStr]?.[t];
                if (cellData) {
                    const taskId = (typeof cellData === 'string') ? cellData : cellData.taskId;
                    const detail = (typeof cellData === 'object') ? (cellData.detail || '') : '';
                    const task = state.tasks.find(tsk => tsk.id === taskId);
                    
                    if (task) {
                        text += `${t} : ${task.name} ${detail ? `(${detail})` : ''}\n`;
                        hasTask = true;
                    }
                }
            });

            if (!hasTask) {
                text += `(‰∫àÂÆö„Å™„Åó)\n`;
            }

            const note = state.schedule[dateStr]?.note;
            if (note) {
                text += `\n[MEMO]\n${note}\n`;
            }

            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
            } catch (err) {
                console.error('Copy failed', err);
                alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'show';
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }

        function renderPalette() {
            const container = document.getElementById('palette-container');
            const deleteBtn = document.getElementById('delete-mode-btn');
            const addBtn = document.getElementById('add-btn');

            if (state.deleteMode) {
                deleteBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> ÂÆå‰∫Ü`;
                deleteBtn.className = "bg-red-500 text-white px-3 py-1 rounded-full transition-colors flex items-center gap-1 text-xs shadow-md border border-red-600 animate-pulse";
                addBtn.disabled = true;
                addBtn.classList.add('opacity-30');
            } else {
                deleteBtn.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i> Êï¥ÁêÜ`;
                deleteBtn.className = "text-slate-400 hover:text-red-500 hover:bg-red-50 px-2 py-1 rounded-full transition-colors flex items-center gap-1 text-xs border border-transparent";
                addBtn.disabled = false;
                addBtn.classList.remove('opacity-30');
            }

            let html = '';

            // Cursor Item
            if (!state.deleteMode) {
                const isCursorSelected = state.activeTaskId === CONFIG.cursorId;
                html += `
                    <div onclick="setActiveTask('${CONFIG.cursorId}')" 
                        class="palette-item relative rounded-lg p-2 cursor-pointer transition-all border border-slate-200 bg-white flex flex-col items-center justify-center gap-1 ${isCursorSelected ? 'selected ring-2 ring-offset-1 ring-slate-400 bg-slate-50' : 'opacity-80 hover:opacity-100 hover:bg-slate-50'}">
                        <i data-lucide="mouse-pointer-2" class="w-6 h-6 ${isCursorSelected ? 'text-indigo-600' : 'text-slate-400'}"></i>
                        <span class="text-[10px] font-bold ${isCursorSelected ? 'text-indigo-600' : 'text-slate-400'}">Á∑®ÈõÜ„ÅÆ„Åø</span>
                        ${isCursorSelected ? '<div class="absolute -top-1 -right-1 bg-indigo-600 text-white rounded-full p-0.5 shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>' : ''}
                    </div>
                `;
            }

            // Task Items
            html += state.tasks.map(t => {
                const isSelected = t.id === state.activeTaskId;
                const hasMemo = t.memo && t.memo.trim().length > 0;
                
                if (state.deleteMode) {
                    return `
                        <div onclick="window.confirmDeleteTask('${t.id}')" 
                            class="palette-item relative rounded-lg p-2 cursor-pointer transition-all border-2 border-red-400 bg-red-50 shake-anim hover:bg-red-100">
                            <div class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center shadow-sm z-10"><i data-lucide="x" class="w-3 h-3"></i></div>
                            <div class="flex items-center gap-2 opacity-70">
                                <div class="w-2 h-8 rounded-full bg-slate-300"></div>
                                <div class="flex-1 min-w-0">
                                    <span class="block w-full font-bold text-xs truncate text-slate-500">${t.name}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Normal Mode with Edit/Info Button
                return `
                    <div onclick="setActiveTask('${t.id}')" 
                        class="palette-item relative rounded-lg p-2 cursor-pointer transition-all border border-transparent ${t.color} ${isSelected ? 'selected ring-2 ring-offset-1 ring-indigo-500/50' : 'opacity-80 hover:opacity-100 hover:shadow-sm'}">
                        <div class="flex items-center gap-1.5">
                            <div class="w-1.5 h-8 rounded-full bg-black/10 flex-shrink-0"></div>
                            
                            <div class="flex-1 min-w-0 flex flex-col justify-center h-full">
                                <input type="text" value="${t.name}" onchange="updateTaskName('${t.id}', this.value)" 
                                    class="w-full bg-transparent font-bold text-xs focus:outline-none focus:bg-white/50 rounded px-0.5 text-inherit truncate leading-tight"
                                    onclick="event.stopPropagation(); pushHistory()">
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex flex-col gap-0.5 flex-shrink-0">
                                <button onclick="event.stopPropagation(); openTaskEditModal('${t.id}')" class="p-1 rounded-full hover:bg-black/10 active:scale-90 transition-transform text-inherit" title="„Çø„Çπ„ÇØË©≥Á¥∞">
                                    <i data-lucide="file-text" class="w-3 h-3 ${hasMemo ? 'fill-current opacity-100' : 'opacity-40'}"></i>
                                </button>
                                <button onclick="event.stopPropagation(); openColorPicker('${t.id}')" class="p-1 rounded-full hover:bg-black/10 active:scale-90 transition-transform text-inherit" title="Ëâ≤Â§âÊõ¥">
                                    <i data-lucide="droplet" class="w-3 h-3 opacity-40"></i>
                                </button>
                            </div>
                        </div>
                        ${isSelected ? '<div class="absolute -top-1 -right-1 bg-indigo-500 text-white rounded-full p-0.5 shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>' : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        // --- Logic ---
        function setActiveTask(id) {
            state.activeTaskId = id;
            renderPalette();
        }

        function toggleDeleteMode() {
            state.deleteMode = !state.deleteMode;
            renderPalette();
        }

        window.confirmDeleteTask = function(id) {
            pushHistory(); // ÂâäÈô§Ââç„Å´Â±•Ê≠¥‰øùÂ≠ò
            if(confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºàÊó¢„Å´Â°ó„Çâ„Çå„Å¶„ÅÑ„Çã„Çπ„Ç±„Ç∏„É•„Éº„É´ÁÆáÊâÄ„ÇÇËâ≤„ÅåÊ∂à„Åà„Åæ„ÅôÔºâ')) {
                state.tasks = state.tasks.filter(t => t.id !== id);
                if(state.activeTaskId === id) {
                    state.activeTaskId = CONFIG.cursorId;
                }
                saveData();
                renderAll(); 
            } else {
                historyStack.pop(); // „Ç≠„É£„É≥„Çª„É´ÊôÇ„ÅØÂ±•Ê≠¥Êàª„Åô
            }
        };

        function handleCellClick(date, time, currentTaskId) {
            if (state.deleteMode) return;

            if (state.activeTaskId === CONFIG.cursorId) {
                if (currentTaskId) {
                    openDetailModal(date, time, currentTaskId);
                }
                return;
            }

            if (currentTaskId === state.activeTaskId) {
                openDetailModal(date, time, currentTaskId);
            } else {
                pushHistory(); // Â§âÊõ¥Ââç„Å´Â±•Ê≠¥‰øùÂ≠ò
                updateSchedule(date, time, state.activeTaskId, ''); 
            }
        }

        function updateSchedule(date, time, taskId, detail) {
            if(!state.schedule[date]) state.schedule[date] = {};
            if(taskId) {
                state.schedule[date][time] = { taskId, detail };
            } else {
                delete state.schedule[date][time];
            }
            saveData();
            renderBody(); 
        }

        function updateMemo(date, val) {
            if(!state.schedule[date]) state.schedule[date] = {};
            state.schedule[date].note = val;
            saveData();
            renderBody();
        }

        // --- Task Management ---
        function addTask() {
            if(state.deleteMode) return;
            pushHistory(); // ËøΩÂä†Ââç„Å´Â±•Ê≠¥‰øùÂ≠ò
            const newId = 't' + Date.now();
            
            const usedColors = state.tasks.map(t => t.color);
            const unusedColors = CONFIG.colors.filter(c => !usedColors.includes(c));
            let color;
            
            if(unusedColors.length > 0) {
                color = unusedColors[Math.floor(Math.random() * unusedColors.length)];
            } else {
                color = CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)];
            }

            state.tasks.push({ id: newId, name: 'Êñ∞Ë¶è', color, memo: '' });
            state.activeTaskId = newId;
            saveData();
            renderPalette();
            const pContainer = document.getElementById('palette-container');
            setTimeout(() => pContainer.scrollTop = pContainer.scrollHeight, 50);
        }

        function updateTaskName(id, name) {
            const t = state.tasks.find(t => t.id === id);
            if(t) {
                t.name = name;
                saveData();
                renderBody();
            }
        }

        // --- Color Picker Logic ---
        function openColorPicker(taskId) {
            state.changingColorTaskId = taskId;
            const grid = document.getElementById('color-grid');
            grid.innerHTML = CONFIG.colors.map(c => `
                <div onclick="selectColor('${c}')" class="w-full h-10 rounded-lg cursor-pointer ${c} border border-black/10 hover:scale-105 transition-transform"></div>
            `).join('');

            const modal = document.getElementById('color-modal');
            const content = document.getElementById('color-modal-content');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
        }

        function closeColorModal() {
            const modal = document.getElementById('color-modal');
            const content = document.getElementById('color-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                state.changingColorTaskId = null;
            }, 200);
        }

        function selectColor(color) {
            if(state.changingColorTaskId) {
                pushHistory(); // Ëâ≤Â§âÊõ¥Ââç„Å´Â±•Ê≠¥‰øùÂ≠ò
                const task = state.tasks.find(t => t.id === state.changingColorTaskId);
                if(task) {
                    task.color = color;
                    saveData();
                    renderAll();
                }
            }
            closeColorModal();
        }

        // --- Task Edit Modal Logic (New!) ---
        function openTaskEditModal(taskId) {
            state.editingTaskId = taskId;
            const task = state.tasks.find(t => t.id === taskId);
            if(!task) return;

            document.getElementById('task-edit-name').value = task.name;
            document.getElementById('task-edit-memo').value = task.memo || '';
            
            const modal = document.getElementById('task-edit-modal');
            const content = document.getElementById('task-modal-content');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
            
            // Focus on memo if name is already set
            if(task.name && task.name !== 'Êñ∞Ë¶è') {
                document.getElementById('task-edit-memo').focus();
            } else {
                document.getElementById('task-edit-name').focus();
            }
        }

        function closeTaskEditModal() {
            const modal = document.getElementById('task-edit-modal');
            const content = document.getElementById('task-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                state.editingTaskId = null;
            }, 200);
        }

        function saveTaskEdit() {
            if(!state.editingTaskId) return;
            pushHistory(); // Â§âÊõ¥Ââç„Å´Â±•Ê≠¥

            const name = document.getElementById('task-edit-name').value;
            const memo = document.getElementById('task-edit-memo').value;
            
            const task = state.tasks.find(t => t.id === state.editingTaskId);
            if(task) {
                task.name = name;
                task.memo = memo;
                saveData();
                renderAll(); // Palette (indicator) & Schedule (if name changed) update
            }
            closeTaskEditModal();
        }


        // --- Detail Modal Logic (Schedule Cell) ---
        function openDetailModal(date, time, taskId) {
            state.editingCell = { date, time };
            const task = state.tasks.find(t => t.id === taskId);
            const cellData = state.schedule[date]?.[time];
            const currentDetail = (typeof cellData === 'object') ? (cellData?.detail || '') : '';

            document.getElementById('modal-task-name').textContent = task ? task.name : 'Unknown';
            const colorDiv = document.getElementById('modal-task-color');
            colorDiv.className = `w-4 h-4 rounded-full shadow-sm ring-1 ring-slate-200 ${task ? task.color.split(' ')[0] : 'bg-gray-400'}`;
            document.getElementById('modal-detail-input').value = currentDetail;

            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
            document.getElementById('modal-detail-input').focus();
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                state.editingCell = null;
            }, 200);
        }

        function saveDetail() {
            if(!state.editingCell) return;
            pushHistory(); // ‰øùÂ≠òÂâç„Å´Â±•Ê≠¥
            const { date, time } = state.editingCell;
            const val = document.getElementById('modal-detail-input').value;
            const current = state.schedule[date][time];
            updateSchedule(date, time, current.taskId, val);
            closeModal();
        }

        function deleteCell() {
            if(!state.editingCell) return;
            pushHistory(); // ÂâäÈô§Ââç„Å´Â±•Ê≠¥
            const { date, time } = state.editingCell;
            updateSchedule(date, time, null, '');
            closeModal();
        }

        // --- Memo Modal Logic ---
        function openMemoModal(date) {
            state.editingMemoDate = date;
            const note = state.schedule[date]?.note || '';
            const d = new Date(date);
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const title = `${d.getMonth()+1}/${d.getDate()} (${dayNames[d.getDay()]}) „ÅÆ„É°„É¢`;
            
            document.getElementById('memo-modal-date').textContent = title;
            document.getElementById('memo-input').value = note;
            
            const modal = document.getElementById('memo-modal');
            const content = document.getElementById('memo-modal-content');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
            document.getElementById('memo-input').focus();
        }

        function closeMemoModal() {
            const modal = document.getElementById('memo-modal');
            const content = document.getElementById('memo-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                state.editingMemoDate = null;
            }, 200);
        }

        function saveMemo() {
            if (!state.editingMemoDate) return;
            pushHistory(); // ‰øùÂ≠òÂâç„Å´Â±•Ê≠¥
            const val = document.getElementById('memo-input').value;
            updateMemo(state.editingMemoDate, val);
            closeMemoModal();
        }

        // --- Helpers ---
        function setupEvents() {
            document.getElementById('prev-btn').onclick = () => {
                state.viewDate.setDate(state.viewDate.getDate() - 7);
                renderAll();
            }
            document.getElementById('next-btn').onclick = () => {
                state.viewDate.setDate(state.viewDate.getDate() + 7);
                renderAll();
            }

            // --- Date Picker Logic (New) ---
            const picker = document.getElementById('date-picker-input');
            picker.addEventListener('change', (e) => {
                if(!e.target.value) return;
                const selectedDate = new Date(e.target.value);
                
                // ÈÅ∏Êäû„Åï„Çå„ÅüÊó•‰ªò„ÇíView„ÅÆÈñãÂßãÊó•„Å´„Çª„ÉÉ„Éà
                selectedDate.setHours(0,0,0,0);
                state.viewDate = selectedDate;
                
                renderAll();
                
                // Ê¨°Âõû„ÅÆ„Åü„ÇÅ„Å´„É™„Çª„ÉÉ„ÉàÔºàÂêå„ÅòÊó•‰ªò„ÇíÈÅ∏„Å≥Áõ¥„Åó„ÅüÊôÇ„Å´„ÇÇÁô∫ÁÅ´„Åô„Çã„Çà„ÅÜ„Å´„Åó„Å¶„ÇÇËâØ„ÅÑ„Åå„ÄÅÂÄ§„ÅØÊÆã„Åó„Å¶„Åä„Åè„Å®‰æøÂà©„Å™„ÅÆ„Åß„Åù„ÅÆ„Åæ„ÅæÔºâ
            });
        }

        // --- Save / Load / Restore Features ---
        function exportData() {
            const dataToSave = {
                version: 1,
                timestamp: new Date().toISOString(),
                data: {
                    tasks: state.tasks,
                    schedule: state.schedule,
                    weeklyMemos: state.weeklyMemos,
                    zoomLevel: state.zoomLevel
                }
            };
            const jsonString = JSON.stringify(dataToSave, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `task_painter_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast("„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
        }

        function triggerImport() {
            document.getElementById('import-file').click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonString = e.target.result;
                    const parsed = JSON.parse(jsonString);
                    // Handle both wrapped format (current) and raw format (potential legacy/manual)
                    const newData = parsed.data || parsed;

                    if (newData.tasks && newData.schedule) {
                        pushHistory(); // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åã„ÇâÂæ©ÂÖÉ„Åô„ÇãÂâç„Å´ÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíUndo„Çπ„Çø„ÉÉ„ÇØ„Å∏
                        state.tasks = newData.tasks;
                        state.schedule = newData.schedule;
                        state.weeklyMemos = newData.weeklyMemos || {};
                        if(newData.zoomLevel) state.zoomLevel = newData.zoomLevel;

                        saveData();
                        renderAll();
                        showToast("„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü");
                    } else {
                        alert("„Ç®„É©„Éº: „Éá„Éº„ÇøÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì");
                    }
                } catch (error) {
                    console.error(error);
                    alert("„Ç®„É©„Éº: „Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü");
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset for re-selection
        }

        window.onload = init;
    </script>
</body>
</html>

